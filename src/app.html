<Header></Header>
<center>
    {{#if loaded}}
        <Location ref:loc1></Location>
        <Location ref:loc2></Location>
        <button on:click="measure()">Measure</button>
        <GoogleMap ref:gmap></GoogleMap>
    {{else}}
    <p>Waiting for border data to load...</p>
    {{/if}}
</center>
<Footer></Footer>
<script>
    import Header from './components/header'
    import Footer from './components/footer'
    import Location from './components/location'
    import GoogleMap from './components/googlemap'
    import async from 'async'

    import GMapsClient from './lib/gmaps_client'
    import {distanceToBorder, pathBetween} from './lib/borderdistance'

    var PATH_TO_MAP = 'maps/segments/canada.json'
    var border
    export default {
        data () {
            return {
                loaded: false,
            }
        },
        components: {
            Header,
            Location,
            GoogleMap
        },
        methods: {
            measure: function () {
                const places = [
                    this.refs.loc1.getValue(),
                    this.refs.loc2.getValue()
                ]
                const colors = [
                    '#ff0000',
                    '#0000ff'
                ]
                return async.map(places, GMapsClient.geocode, (err, results) => {
                    if (err) {
                        throw err
                    }
                    const dists = results.map((x)=>distanceToBorder(border, x.lat, x.lng))

                    this.refs.gmap.reset()

                    results.map((x, idx) => {
                        this.refs.gmap.addLocation(x.lat, x.lng, places[idx], dists[idx].distance)
                    })

                    results.map((x, idx) => {
                        this.refs.gmap.addPath(
                            pathBetween(x.lat, x.lng, dists[idx].point[0], dists[idx].point[1]),
                            colors[idx]
                        )
                    })
                    this.refs.loc1.set({'dist': dists[0].distance})
                    this.refs.loc2.set({'dist': dists[1].distance})
                })
            }
        },
        onrender () {
            fetch(PATH_TO_MAP).then((res) => {
                return res.json()
            })
            .then((result) => {
                border = result
                    console.log('loaded')
                this.set({'loaded': true})
            })
        }
    }
</script>
