<Header></Header>
<center>
<Location ref:loc1></Location>
<Location ref:loc2></Location>
<button on:click='measure()'>Compute</button>
<button on:click='debug()'>Debug</button>
<GoogleMap ref:gmap></GoogleMap>
</center>
<script>
    import Header from './components/header'
    import Location from './components/location'
    import GoogleMap from './components/googlemap'
    import async from 'async'

    import GMapsClient from './lib/gmaps_client'
    import {distanceToBorder, pathBetween} from './lib/borderdistance'

    var border
    export default {
        components: {
            Header,
            Location,
            GoogleMap
        },
        methods: {
            measure: function () {
                const places = [
                    this.refs.loc1.getValue(),
                    this.refs.loc2.getValue()
                ]
                const colors = [
                    '#ff0000',
                    '#0000ff'
                ]
                return async.map(places, GMapsClient.geocode, (err, results) => {
                    if (err) {
                        throw err
                    }
                    const dists = results.map((x)=>distanceToBorder(border, x.lat, x.lng))

                    this.refs.gmap.reset()

                    results.map((x, idx) => {
                        this.refs.gmap.addLocation(x.lat, x.lng, places[idx], dists[idx].distance)
                    })

                    results.map((x, idx) => {
                        this.refs.gmap.addPath(
                            pathBetween(x.lat, x.lng, dists[idx].point[0], dists[idx].point[1]),
                            colors[idx]
                        )
                    })

                })

                //this.refs.gmap.addLocation(
                //    this.refs.loc1.getValue()
                //)
            },
            debug: function () {
                //border.map((x) => {
                //    this.refs.gmap.addPath(
                //        [
                //          [x.start.lat, x.start.lon],
                //          [x.end.lat, x.end.lon]
                //        ],
                //        '#00ff00'
                //    )
                //})
                console.log('adding...')
                this.refs.gmap.addLocation(49.41587, -62.9393, 'moo', 'moo')
                this.refs.gmap.addLocation(46.55001, -63.6645, 'moot', 'moot')
                this.refs.gmap.addPath([[-62.9393, 49.41587], [-63.6645, 46.55001]], '#ffff00')
            }
        },
        onrender () {
            console.log('fetching...')
            fetch('maps/segments/canada.json').then((res) => {
                return res.json()
            })
            .then((result) => {
                border = result
            })
        }
    }
</script>
